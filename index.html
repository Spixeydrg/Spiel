<script>

class Player{
    constructor(name){
        this.name=name;
        this.age=0;
        this.country="Deutschland";
        this.health=80;
        this.happiness=80;
        this.intelligence=50;
        this.looks=50;
        this.money=2000;
        this.job="Arbeitslos";
        this.reputation=50;
        this.loan=0;
        this.inPrison=false;
        this.prisonYears=0;
        this.alive=true;
    }
}

class Game{
    constructor(){
        this.player=null;
        this.countries={
            "Deutschland":{tax:0.30},
            "USA":{tax:0.25},
            "Schweiz":{tax:0.15}
        };
        this.jobs=[
            {name:"Kellner", req:0, salary:1500},
            {name:"Programmierer", req:60, salary:5000},
            {name:"Arzt", req:75, salary:7000},
            {name:"Politiker", req:65, salary:6000}
        ];
    }

    start(){
        const save=localStorage.getItem("lifeSimPhase2");
        if(save){
            this.player=Object.assign(new Player(),JSON.parse(save));
        }else{
            const name=prompt("Name?");
            this.player=new Player(name||"Alex");
            this.save();
        }
        this.render();
    }

    save(){
        localStorage.setItem("lifeSimPhase2",JSON.stringify(this.player));
    }

    ageUp(){
        const p=this.player;
        if(!p.alive)return;

        p.age++;

        if(p.inPrison){
            p.prisonYears--;
            if(p.prisonYears<=0){
                p.inPrison=false;
                alert("Du bist frei!");
            }
        }else{
            this.randomEvent();
            this.paySalary();
            this.payLoanInterest();
        }

        if(p.age>80 && Math.random()<0.35) this.die("Alter");
        if(p.health<=0) this.die("Gesundheit");

        this.limitStats();
        this.save();
        this.render();
    }

    limitStats(){
        let p=this.player;
        ["health","happiness","intelligence","looks","reputation"].forEach(stat=>{
            if(p[stat]>100)p[stat]=100;
            if(p[stat]<0)p[stat]=0;
        });
    }

    die(reason){
        this.player.alive=false;
        alert(`${this.player.name} starb mit ${this.player.age} an ${reason}`);
    }

    changeCountry(country){
        this.player.country=country;
        this.save();
        this.render();
    }

    paySalary(){
        const job=this.jobs.find(j=>j.name===this.player.job);
        if(!job)return;

        const tax=this.countries[this.player.country].tax;
        const net=job.salary*(1-tax);
        this.player.money+=net;
    }

    findJob(){
        const available=this.jobs.filter(j=>this.player.intelligence>=j.req);
        if(available.length===0){
            alert("Keine Qualifikation!");
            return;
        }
        const job=available[Math.floor(Math.random()*available.length)];
        this.player.job=job.name;
        this.player.happiness+=5;
    }

    randomEvent(){
        const events=[
            ()=>{
                this.player.health-=15;
                alert("Du wurdest krank.");
            },
            ()=>{
                this.player.intelligence+=5;
                alert("Du hast etwas gelernt.");
            },
            ()=>{
                this.player.reputation-=10;
                alert("Skandal! Ruf gesunken.");
            }
        ];
        events[Math.floor(Math.random()*events.length)]();
    }

    commitCrime(){
        if(Math.random()<0.5){
            this.player.money+=4000;
            this.player.reputation-=15;
        }else{
            this.player.inPrison=true;
            this.player.prisonYears=3;
            this.player.reputation-=25;
        }
        this.save();
        this.render();
    }

    takeLoan(){
        this.player.money+=10000;
        this.player.loan+=10000;
        this.save();
        this.render();
    }

    repayLoan(){
        if(this.player.money>=this.player.loan){
            this.player.money-=this.player.loan;
            this.player.loan=0;
        }
        this.save();
        this.render();
    }

    payLoanInterest(){
        if(this.player.loan>0){
            this.player.loan*=1.05;
        }
    }

    statBar(val,color){
        return `<div class="statbar" style="width:${val}%;background:${color}"></div>`;
    }

    render(){
        const p=this.player;
        document.getElementById("game").innerHTML=`
        <div class="card">
            <h2>${p.name} (${p.age})</h2>
            <p>ğŸŒ ${p.country}</p>
            <p>ğŸ’° ${Math.floor(p.money)}â‚¬</p>
            <p>ğŸ’¼ ${p.job}</p>
            <p>ğŸ¦ Kredit: ${Math.floor(p.loan)}â‚¬</p>
            <p>â­ Ruf: ${p.reputation}</p>
            <p>ğŸš” GefÃ¤ngnis: ${p.inPrison ? p.prisonYears+" Jahre" : "Nein"}</p>
        </div>

        <div class="card">
            â¤ï¸ ${this.statBar(p.health,"red")}
            ğŸ˜Š ${this.statBar(p.happiness,"yellow")}
            ğŸ§  ${this.statBar(p.intelligence,"blue")}
            ğŸ˜ ${this.statBar(p.looks,"pink")}
        </div>

        <div class="card">
            ${p.alive?
            `<button onclick="game.ageUp()">NÃ¤chstes Jahr</button>`:
            `<button onclick="localStorage.clear();location.reload()">Neues Leben</button>`}
            <button onclick="game.findJob()">Job suchen</button>
            <button onclick="game.commitCrime()">Verbrechen</button>
            <button onclick="game.takeLoan()">Kredit</button>
            <button onclick="game.repayLoan()">Kredit zurÃ¼ckzahlen</button>
        </div>

        <div class="card">
            LÃ¤nder wechseln:<br>
            ${Object.keys(this.countries).map(c=>
                `<button onclick="game.changeCountry('${c}')">${c}</button>`
            ).join("")}
        </div>
        `;
    }
}

const game=new Game();
game.start();

</script>
